(() => {
  console.log('Loaded snippet');

  function openPopup() {
    document.getElementById('main-jolted-popup').classList.add('open');
    document.getElementById('jolted-popup-background').classList.add('open');

    document.body.style.overflow = 'hidden';
  }

  function closePopup() {
    document.getElementById('main-jolted-popup').classList.remove('open');
    document.getElementById('jolted-popup-background').classList.remove('open');
    document.body.style.overflow = 'visible';
    document.getElementById('jolted-popup-tab').style.display = 'none';
  }

  function checkPreviewMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const isPreview = urlParams.get('jolted_preview') === 'true';
    return isPreview;
  }

  if (window.addEventListener) {
    window.addEventListener("message", onJoltedMessage, false);
  }

  else if (window.attachEvent) {
    window.attachEvent("onmessage", onJoltedMessage, false);
  }

  function onJoltedMessage(event) {
    if (event.data.message === 'OPEN_POPUP') {
      openPopup();
    }

    if (event.data.message === 'CLOSE_POPUP') {
      closePopup();
    }
  }

  const live = <%= @wheel.live? %>;
  const preview = checkPreviewMode();
  if (!live && !preview) return;

  const popup = document.createElement('div');
  popup.innerHTML = `<%= render 'popup' %>`;
  popup.innerHTML = popup.innerHTML.replace('jolted_preview=false', `jolted_preview=${preview}`);
  document.body.insertBefore(popup, document.body.firstChild);
})();
